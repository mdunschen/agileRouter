<!DOCTYPE html>
<html lang="en">
<head>
    <title>Agile Route Planner App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<script src="https://code.jquery.com/jquery-1.12.4.min.js"
			integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
			crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script>
    var cyclistArtIn = ["------__o", "-----_\ <,_", "----(_)/ (_)"];
    var cyclistArt = cyclistArtIn.slice(0, 3);

    class StateChanges {
        constructor() {
            this.status = false;
        }

        changeStatus(newStatus) {
            this.status = newStatus;
        }

        getStatus() {
            return this.status;
        }
    }

    var resultReceived = new StateChanges();

    function debugWrite(txt) {
        document.getElementById("adresses").value += txt;
    }

    function request(type, url, data, callback) {
        var req = new XMLHttpRequest();
        req.open(type, url, true);
        if (data != false) {
            req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        }
        req.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                callback(req.responseText);
            }
        }

        if (data != false) {
            req.send(data);
        } else {
            req.send();
        }
    }

    function reportProgress(txt) {
        if (resultReceived.getStatus() == false) {
            updateTextEdit(txt);
        }
    }

    function updateTextEdit(txt, clear = false) {
        if (clear) {
            document.getElementById("adresses").value = txt;
        } else {
            document.getElementById("adresses").value += txt;
        }
    }


    function requestProgress() {
        if (resultReceived.getStatus() == false) {
            request('GET', '/router?getprogress', false, reportProgress);
        }
    }

    function onReceiveResult(txt) {
        resultReceived.changeStatus(true);
        updateTextEdit(txt, true);
        buildMapLinks();
    }

    function submitAdresses() {
        var adr = "adresses=";
        var data = adr.concat(encodeURI(document.getElementById("adresses").value));
        var oneway = "oneway=";
        var val = document.getElementById("oneway").checked ? "1" : "0";
        data = data.concat("&oneway=", encodeURI(val));
        updateTextEdit("", true);
        request('POST', '/router', data, onReceiveResult);
    }

    function loadProgress() {
        if (resultReceived.getStatus() == false) {
            cyclistArt[0] = '-' + cyclistArt[0];
            cyclistArt[1] = '-' + cyclistArt[1];
            cyclistArt[2] = '-' + cyclistArt[2];

            if (cyclistArt[2].length == 80) {
                cyclistArt = cyclistArtIn.slice(0, 3);
            }

            updateTextEdit(cyclistArt.join(String.fromCharCode(10)), true);
            requestProgress();
            setTimeout(loadProgress, 500);
        }
    }



    function doSubmit() {
        resultReceived.changeStatus(false);
        document.getElementById("map").innerHTML = "";
        submitAdresses();
        loadProgress();
    }

    function onLegDone(iLeg) {
        // write the time it was done into the label
        var lab = document.getElementById("labelLeg" + iLeg);
        options = {
            year: 'numeric', month: 'numeric', day: 'numeric',
            hour: 'numeric', minute: 'numeric', second: 'numeric',
            hour12: false };
        var d = new Date();
        var fmt = new Intl.DateTimeFormat('en-GB', options);
        lab.innerHTML = fmt.format(d);

        // disable checkbox
        var box = document.getElementById("leg" + iLeg);
        box.disabled = true;

    }

    function buildMapLinks() {
        // we read the data from the text edit and build links between each pair
        var googleMapDirUrl = "https://www.google.co.uk/maps/dir/%s/%s/data=!4m2!4m1!3e1"

        var addresses = document.getElementById("adresses").value.split(';');

        document.getElementById("map").innerHTML += "<br><br><strong>Legs on google maps:</strong><br>";

        // loop over addresses an build legs
        var legTable = '<table>';
        legTable += '<tr><th>Leg</th><th colspan=2>Done</th></tr>';
        for (var i = 1; i < addresses.length; ++i) {
            var a = addresses[i - 1].replace(" ", "+");
            var b = addresses[i].replace(" ", "+");
            var leg = "https://www.google.co.uk/maps/dir/" + a + "/" + b + "/data=!4m2!4m1!3e1"
            var legLink = '<a href="' + leg + '" target="_blank">' + "Leg " + i + '</a>'
            var checkBox = '<input type="checkbox" id="leg' + i + '" value = "legDone" onClick = "onLegDone(' + i + ');">';
            var lab = '<label id="labelLeg' + i + '" for="leg' + i + '">Done</label>';
            legTable += '<tr><td>' + legLink + '</td><td>' + checkBox + '</td><td>' + lab + '</td></tr>';
        }
        legTable += '</table>';
        document.getElementById("map").innerHTML += legTable;

    }
    </script>
</head>
<body>
<div data-role="page">

	<div data-role="header"><h1 style="font-family: Helvetica;">Agile Route Planner</h1></div>
    <div data-role="content">
        <form >
            <div class = "ui-field-contain">
                <textarea rows=10 cols=80 autogrow=on autocorrect=off placeholder = "Addresses (separate with ';')" id="adresses" name="adresses">{{ addresses }}</textarea><br>
                <input type="checkbox" id="oneway" name="oneway" value = "useOneWay"><label for="oneway">One Way*</label><br>
                <input type="button" value="Calculate" onClick = "doSubmit();">
            </div>
        </form>
        <div class = "ui-field-contain" id="map">
            {% if maproute %}
                {{ maproute }}
            {% else %}
                <p style="font-size: smaller;">(*) One Way checked: A shortest route from first to last destination in the list is returned, otherwise it returns close to the first in list.
                </p>
            {% endif %}
        </div>
    </div>
</div>
</body>
</html>
